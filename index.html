<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VIBE</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg: #ffffff;
        --fg: #000000;
        --border: #000000;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--fg);
        font-family: 'Syne', sans-serif;
        overflow: hidden;
      }

      .ui {
        position: relative;
        width: 100vw;
        height: 100vh;
      }

      .top-left {
        position: absolute;
        top: 20px;
        left: 24px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .top-right {
        position: absolute;
        top: 20px;
        right: 24px;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
      }

      .label {
        font-size: 0.72rem;
        letter-spacing: 0.12em;
        font-weight: 700;
      }

      input[type='range'] {
        accent-color: var(--fg);
      }

      .vibe-select {
        width: 170px;
        background: var(--bg);
        color: var(--fg);
        border: 1px solid var(--border);
        font-family: inherit;
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        padding: 7px 10px;
        text-transform: uppercase;
      }

      .space-slider {
        width: min(34vw, 260px);
      }

      .text-zone {
        position: absolute;
        left: 50%;
        top: 47%;
        transform: translate(-50%, -50%);
        width: min(88vw, 1200px);
        border-top: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        padding: 14px 0 10px;
      }

      .ticker-viewport {
        overflow: hidden;
      }

      .ticker {
        display: inline-flex;
        align-items: center;
        gap: 4rem;
        white-space: nowrap;
        font-size: clamp(3rem, 9vw, 9rem);
        line-height: 1;
        font-weight: 800;
        letter-spacing: -0.02em;
        will-change: transform;
      }

      .ticker.is-placeholder {
        color: #b8b8b8;
      }

      .ticker.is-moving {
        animation: slide-left var(--duration, 10s) linear infinite;
      }

      @keyframes slide-left {
        from {
          transform: translateX(0);
        }
        to {
          transform: translateX(calc(-1 * var(--shift, 0px)));
        }
      }

      .start-hint {
        margin: 12px 0 0;
        text-align: center;
        font-size: 0.72rem;
        letter-spacing: 0.12em;
        font-weight: 700;
        color: #9d9d9d;
        transition: opacity 0.2s ease;
      }

      .start-hint.is-hidden {
        opacity: 0;
      }

      .center-bottom {
        position: absolute;
        left: 50%;
        bottom: 22px;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
      }

      .volume-wrap {
        width: 170px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .volume-slider {
        width: 150px;
        transform: rotate(-90deg);
        transform-origin: center;
      }

      .bottom-btn {
        position: absolute;
        bottom: 24px;
        background: transparent;
        color: var(--fg);
        border: 1px solid var(--border);
        font-family: inherit;
        font-weight: 700;
        letter-spacing: 0.08em;
        font-size: 0.72rem;
        padding: 10px 14px;
        text-transform: uppercase;
        cursor: pointer;
      }

      .bottom-btn:hover {
        background: var(--fg);
        color: var(--bg);
      }

      .btn-left {
        left: 24px;
      }

      .btn-right {
        right: 24px;
      }

      .audio-gate {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.95);
        z-index: 20;
      }

      .audio-gate.is-hidden {
        display: none;
      }

      .audio-start-btn {
        min-width: min(70vw, 460px);
        border: 2px solid var(--border);
        background: var(--bg);
        color: var(--fg);
        font-family: inherit;
        font-size: clamp(1.2rem, 3.8vw, 2.2rem);
        letter-spacing: 0.12em;
        font-weight: 800;
        text-transform: uppercase;
        padding: 20px 26px;
        cursor: pointer;
      }

      .audio-start-btn:hover {
        background: var(--fg);
        color: var(--bg);
      }

      @media (max-width: 768px) {
        .text-zone {
          top: 44%;
        }

        .top-right {
          left: 24px;
          right: auto;
          top: 58px;
          align-items: flex-start;
        }

        .space-slider {
          width: min(64vw, 280px);
        }

        .center-bottom {
          bottom: 84px;
        }
      }
    </style>
  </head>
  <body>
    <main class="ui">
      <section class="top-left" aria-label="Selector de vibe">
        <label class="label" for="vibe">VIBE</label>
        <select id="vibe" class="vibe-select">
          <option value="sine">CALMA</option>
          <option value="triangle">BRUMA</option>
          <option value="sawtooth">TENSIÓN</option>
          <option value="square">CRUDO</option>
        </select>
      </section>

      <section class="top-right" aria-label="Control de espacio">
        <label class="label" for="space">ESPACIO</label>
        <input id="space" class="space-slider" type="range" min="0" max="100" value="25" />
      </section>

      <section class="text-zone" aria-label="Frase principal">
        <div class="ticker-viewport">
          <div id="ticker" class="ticker is-placeholder">
            <span id="phrase"></span>
            <span id="phraseEcho" aria-hidden="true"></span>
          </div>
        </div>
        <p id="startHint" class="start-hint">ESCRIBE PARA INICIAR</p>
      </section>

      <section class="center-bottom" aria-label="Control de volumen">
        <div class="volume-wrap">
          <input id="volume" class="volume-slider" type="range" min="0" max="100" value="75" />
        </div>
        <label class="label" for="volume">VOLUMEN</label>
      </section>

      <button id="fontBtn" class="bottom-btn btn-left" type="button">TIPOGRAFÍA</button>
      <button id="newPhraseBtn" class="bottom-btn btn-right" type="button">NUEVA FRASE</button>

      <div id="audioGate" class="audio-gate">
        <button id="audioStartBtn" class="audio-start-btn" type="button">INICIAR AUDIO</button>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    <script>
      const ticker = document.getElementById('ticker');
      const tickerViewport = document.querySelector('.ticker-viewport');
      const phrase = document.getElementById('phrase');
      const phraseEcho = document.getElementById('phraseEcho');
      const startHint = document.getElementById('startHint');
      const newPhraseBtn = document.getElementById('newPhraseBtn');
      const fontBtn = document.getElementById('fontBtn');
      const vibeSelect = document.getElementById('vibe');
      const volumeSlider = document.getElementById('volume');
      const audioGate = document.getElementById('audioGate');
      const audioStartBtn = document.getElementById('audioStartBtn');
      const scaleNotes = ['C4', 'D4', 'E4', 'F4', 'G4', 'A4', 'B4'];
      const suggestedPhrases = [
        'LA VIBRA ESTA EN EL AIRE',
        'TODO EMPIEZA CON UNA PALABRA',
        'DEJA QUE EL RITMO TE GUIE',
        'RESPIRA Y SIGUE ESCRIBIENDO',
        'HOY SUENA DISTINTO',
        'MANTEN LA ENERGIA ARRIBA'
      ];
      let currentSuggestion = '';
      let typedSuffix = '';
      let hasStartedTyping = false;
      let synth = null;
      let audioReady = false;

      function getRandomSuggestion() {
        if (suggestedPhrases.length === 1) {
          return suggestedPhrases[0];
        }

        let next = suggestedPhrases[Math.floor(Math.random() * suggestedPhrases.length)];
        while (next === currentSuggestion) {
          next = suggestedPhrases[Math.floor(Math.random() * suggestedPhrases.length)];
        }
        return next;
      }

      function renderPhrase() {
        const composed = `${currentSuggestion}${typedSuffix}`;
        phrase.textContent = composed;
        phraseEcho.textContent = composed;
        ticker.classList.toggle('is-placeholder', !hasStartedTyping);
        startHint.classList.toggle('is-hidden', hasStartedTyping);
      }

      function updateTickerMotion(restart = false) {
        ticker.classList.remove('is-moving');
        ticker.style.removeProperty('--shift');
        ticker.style.removeProperty('--duration');

        if (restart) {
          void ticker.offsetWidth;
        }

        const containerWidth = tickerViewport.clientWidth;
        const textWidth = phrase.getBoundingClientRect().width;

        if (textWidth > containerWidth) {
          const shift = textWidth + 64;
          const duration = Math.max(8, shift / 120);
          ticker.style.setProperty('--shift', `${shift}px`);
          ticker.style.setProperty('--duration', `${duration}s`);
          ticker.classList.add('is-moving');
        }
      }

      function normalizeKeyToLetter(value) {
        if (!value || value.length !== 1) {
          return '';
        }

        return value
          .normalize('NFD')
          .replace(/[\u0300-\u036f]/g, '')
          .toLowerCase();
      }

      function setSynthVolume() {
        if (!synth) {
          return;
        }

        const amount = Number(volumeSlider.value);
        const decibels = -36 + amount * 0.36;
        synth.volume.value = decibels;
      }

      async function startAudio() {
        if (audioReady) {
          return;
        }

        await Tone.start();
        synth = new Tone.PolySynth(Tone.Synth, {
          oscillator: { type: vibeSelect.value },
          envelope: { attack: 0.01, decay: 0.1, sustain: 0.25, release: 1.1 }
        }).toDestination();
        setSynthVolume();
        audioReady = true;
        audioGate.classList.add('is-hidden');
      }

      function playLetterSound(inputChar) {
        if (!audioReady || !synth) {
          return;
        }

        const normalized = normalizeKeyToLetter(inputChar);
        if (!/^[a-z]$/.test(normalized)) {
          return;
        }

        const index = normalized.charCodeAt(0) - 97;
        const note = scaleNotes[index % scaleNotes.length];
        synth.triggerAttackRelease(note, '8n');
      }

      function resetPhraseState() {
        currentSuggestion = getRandomSuggestion();
        typedSuffix = '';
        hasStartedTyping = false;
        if (synth) {
          synth.releaseAll();
        }
        renderPhrase();
        requestAnimationFrame(() => updateTickerMotion(true));
      }

      newPhraseBtn.addEventListener('click', resetPhraseState);
      vibeSelect.addEventListener('change', () => {
        if (synth) {
          synth.set({ oscillator: { type: vibeSelect.value } });
        }
      });
      volumeSlider.addEventListener('input', setSynthVolume);
      audioStartBtn.addEventListener('click', startAudio);

      fontBtn.addEventListener('click', () => {
        document.body.style.fontWeight = document.body.style.fontWeight === '800' ? '400' : '800';
        requestAnimationFrame(() => updateTickerMotion(true));
      });

      window.addEventListener('keydown', (event) => {
        if (event.repeat) {
          return;
        }

        if (event.ctrlKey || event.metaKey || event.altKey) {
          return;
        }

        const tagName = event.target && event.target.tagName ? event.target.tagName : '';
        if (tagName === 'INPUT' || tagName === 'BUTTON' || tagName === 'SELECT') {
          return;
        }

        if (event.key === 'Backspace') {
          if (typedSuffix.length === 0) {
            return;
          }

          event.preventDefault();
          typedSuffix = typedSuffix.slice(0, -1);
          hasStartedTyping = typedSuffix.length > 0;
          renderPhrase();
          requestAnimationFrame(() => updateTickerMotion(true));
          return;
        }

        if (event.key === ' ') {
          hasStartedTyping = true;
          typedSuffix += ' ';
          renderPhrase();
          requestAnimationFrame(() => updateTickerMotion(true));
          return;
        }

        const normalized = normalizeKeyToLetter(event.key);
        if (!/^[a-z]$/.test(normalized)) {
          return;
        }

        hasStartedTyping = true;
        typedSuffix += event.key;
        renderPhrase();
        requestAnimationFrame(() => updateTickerMotion(true));
        playLetterSound(event.key);
      });

      window.addEventListener('resize', () => updateTickerMotion(false));
      window.addEventListener('load', resetPhraseState);
    </script>
  </body>
</html>
